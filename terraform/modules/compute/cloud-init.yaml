#cloud-config
#
# Cloud-init configuration for Metal Foundry control plane
# This runs on first boot to prepare the system
#

hostname: ${hostname}

# Update and install basic packages
package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - jq
  - unzip
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release
  - iptables
  - iptables-persistent
  - open-iscsi
  - nfs-common

# Configure system settings
write_files:
  # Disable swap (required for Kubernetes)
  - path: /etc/sysctl.d/99-kubernetes.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
      vm.swappiness = 0

  # K3s configuration
  - path: /etc/rancher/k3s/config.yaml
    content: |
      disable:
        - flannel
        - traefik
        - servicelb
        - local-storage
      flannel-backend: none
      disable-network-policy: true
      write-kubeconfig-mode: "0644"
      tls-san:
        - "${hostname}"

  # Marker file for bootstrap script
  - path: /var/lib/cloud/scripts/per-once/99-ready-marker.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      touch /var/lib/metal-foundry-ready

runcmd:
  # Disable swap
  - swapoff -a
  - sed -i '/swap/d' /etc/fstab

  # Load kernel modules
  - modprobe br_netfilter
  - modprobe overlay
  - echo "br_netfilter" >> /etc/modules-load.d/k8s.conf
  - echo "overlay" >> /etc/modules-load.d/k8s.conf

  # Apply sysctl settings
  - sysctl --system

  # Configure iptables for K3s and Cilium
  # OCI security lists handle external filtering, these rules are for internal traffic
  - iptables -A INPUT -i lo -j ACCEPT
  - iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
  - iptables -A INPUT -p tcp --dport 22 -j ACCEPT
  - iptables -A INPUT -p tcp --dport 80 -j ACCEPT
  - iptables -A INPUT -p tcp --dport 443 -j ACCEPT
  - iptables -A INPUT -p tcp --dport 6443 -j ACCEPT
  - iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
  - iptables -A INPUT -p udp --dport 41641 -j ACCEPT
  - iptables -A INPUT -p icmp -j ACCEPT
  # Allow all pod/service traffic (Cilium manages this)
  - iptables -A INPUT -s 10.0.0.0/8 -j ACCEPT
  - iptables -A FORWARD -j ACCEPT
  - netfilter-persistent save 2>/dev/null || true

  # Start iscsid for potential storage needs
  - systemctl enable iscsid
  - systemctl start iscsid

  # Install Tailscale (if auth key provided)
%{ if tailscale_auth_key != "" }
  - curl -fsSL https://tailscale.com/install.sh | sh
  - tailscale up --auth-key="${tailscale_auth_key}" --hostname="${hostname}" --accept-routes
%{ endif }

  # Install K3s (latest stable, without flannel - we'll use Cilium)
  - |
    echo "Installing K3s..." >> /var/log/metal-foundry-init.log
    curl -sfL https://get.k3s.io | INSTALL_K3S_CHANNEL=stable INSTALL_K3S_EXEC="server" sh -

  # Wait for K3s to be ready
  - |
    echo "Waiting for K3s..." >> /var/log/metal-foundry-init.log
    until kubectl get nodes 2>/dev/null; do sleep 5; done

  # Install Helm
  - |
    echo "Installing Helm..." >> /var/log/metal-foundry-init.log
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

  # Install Cilium CLI
  - |
    echo "Installing Cilium CLI..." >> /var/log/metal-foundry-init.log
    CILIUM_CLI_VERSION=$(curl -s https://raw.githubusercontent.com/cilium/cilium-cli/main/stable.txt)
    CLI_ARCH=amd64
    if [ "$(uname -m)" = "aarch64" ]; then CLI_ARCH=arm64; fi
    curl -L --fail --remote-name-all https://github.com/cilium/cilium-cli/releases/download/${CILIUM_CLI_VERSION}/cilium-linux-${CLI_ARCH}.tar.gz
    tar xzvf cilium-linux-${CLI_ARCH}.tar.gz -C /usr/local/bin
    rm cilium-linux-${CLI_ARCH}.tar.gz

  # Install Cilium CNI (latest stable)
  - |
    echo "Installing Cilium..." >> /var/log/metal-foundry-init.log
    export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
    cilium install

  # Wait for Cilium to be ready
  - |
    echo "Waiting for Cilium..." >> /var/log/metal-foundry-init.log
    export KUBECONFIG=/etc/rancher/k3s/k3s.yaml
    cilium status --wait

  # Install Flux CLI (latest)
  - |
    echo "Installing Flux CLI..." >> /var/log/metal-foundry-init.log
    curl -s https://fluxcd.io/install.sh | bash

  # Install kubectl krew plugin manager
  - |
    echo "Installing krew..." >> /var/log/metal-foundry-init.log
    (
      set -x; cd "$(mktemp -d)" &&
      OS="$(uname | tr '[:upper:]' '[:lower:]')" &&
      ARCH="$(uname -m | sed -e 's/x86_64/amd64/' -e 's/aarch64/arm64/')" &&
      KREW="krew-${OS}_${ARCH}" &&
      curl -fsSLO "https://github.com/kubernetes-sigs/krew/releases/latest/download/${KREW}.tar.gz" &&
      tar zxvf "${KREW}.tar.gz" &&
      ./"${KREW}" install krew
    )
    echo 'export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"' >> /root/.bashrc
    echo 'export PATH="${KREW_ROOT:-$HOME/.krew}/bin:$PATH"' >> /home/ubuntu/.bashrc

  # Make kubeconfig accessible to ubuntu user
  - |
    mkdir -p /home/ubuntu/.kube
    cp /etc/rancher/k3s/k3s.yaml /home/ubuntu/.kube/config
    chown -R ubuntu:ubuntu /home/ubuntu/.kube
    echo 'export KUBECONFIG=/home/ubuntu/.kube/config' >> /home/ubuntu/.bashrc

  # Mark complete
  - echo "K3s, Cilium, Flux installed successfully!" >> /var/log/metal-foundry-init.log

# Final message
final_message: |
  Metal Foundry control plane ready!
  K3s + Cilium installed.
  Elapsed time: $UPTIME seconds.
