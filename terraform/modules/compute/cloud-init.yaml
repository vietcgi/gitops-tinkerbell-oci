#cloud-config
#
# Cloud-init configuration for Metal Foundry control plane
# This prepares the system and optionally runs the cluster setup
#

hostname: ${hostname}

# Update and install basic packages
package_update: true
package_upgrade: true

packages:
  - curl
  - wget
  - git
  - jq
  - unzip
  - apt-transport-https
  - ca-certificates
  - gnupg
  - lsb-release
  - iptables
  - iptables-persistent
  - open-iscsi
  - nfs-common

# Configure system settings
write_files:
  # Kubernetes sysctl settings
  - path: /etc/sysctl.d/99-kubernetes.conf
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
      vm.swappiness = 0

  # K3s configuration
  - path: /etc/rancher/k3s/config.yaml
    content: |
      disable:
        - flannel
        - traefik
        - servicelb
        - local-storage
      flannel-backend: none
      disable-network-policy: true
      write-kubeconfig-mode: "0644"
      tls-san:
        - "${hostname}"
        - "localhost"
        - "127.0.0.1"

  # Setup script with retry logic
  - path: /usr/local/bin/metal-foundry-setup
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail

      SCRIPT_URL="https://raw.githubusercontent.com/vietcgi/gitops-metal-foundry/main/scripts/setup-cluster.sh"
      LOG_FILE="/var/log/metal-foundry-setup.log"
      MAX_RETRIES=5
      RETRY_DELAY=30

      log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" | tee -a "$LOG_FILE"; }

      download_with_retry() {
        local url=$1
        local output=$2
        local attempt=1

        while [ $attempt -le $MAX_RETRIES ]; do
          log "Downloading setup script (attempt $attempt/$MAX_RETRIES)..."
          if curl -sfL "$url" -o "$output" && [ -s "$output" ]; then
            log "Download successful"
            return 0
          fi
          log "Download failed, waiting ${RETRY_DELAY}s before retry..."
          sleep $RETRY_DELAY
          attempt=$((attempt + 1))
        done

        log "ERROR: Failed to download after $MAX_RETRIES attempts"
        return 1
      }

      main() {
        log "=== Metal Foundry Setup Starting ==="

        # Download setup script
        if ! download_with_retry "$SCRIPT_URL" "/tmp/setup-cluster.sh"; then
          log "ERROR: Could not download setup script"
          log "Manual setup required. SSH in and run:"
          log "  curl -sfL $SCRIPT_URL | sudo bash"
          exit 1
        fi

        chmod +x /tmp/setup-cluster.sh

        # Run setup
        log "Running setup script..."
        if /tmp/setup-cluster.sh; then
          log "=== Setup Complete ==="
          echo "complete" > /var/log/metal-foundry-status
        else
          log "ERROR: Setup script failed"
          echo "failed" > /var/log/metal-foundry-status
          exit 1
        fi
      }

      main "$@"

runcmd:
  # Disable swap
  - swapoff -a
  - sed -i '/swap/d' /etc/fstab

  # Load kernel modules
  - modprobe br_netfilter
  - modprobe overlay
  - echo "br_netfilter" >> /etc/modules-load.d/k8s.conf
  - echo "overlay" >> /etc/modules-load.d/k8s.conf

  # Apply sysctl settings
  - sysctl --system

  # Configure iptables
  - iptables -A INPUT -i lo -j ACCEPT
  - iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
  - iptables -A INPUT -p tcp --dport 22 -j ACCEPT
  - iptables -A INPUT -p tcp --dport 80 -j ACCEPT
  - iptables -A INPUT -p tcp --dport 443 -j ACCEPT
  - iptables -A INPUT -p tcp --dport 6443 -j ACCEPT
  - iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
  - iptables -A INPUT -p tcp --dport 10250 -j ACCEPT
  - iptables -A INPUT -p udp --dport 41641 -j ACCEPT
  - iptables -A INPUT -p icmp -j ACCEPT
  - iptables -A INPUT -s 10.0.0.0/8 -j ACCEPT
  - iptables -A FORWARD -j ACCEPT
  - netfilter-persistent save 2>/dev/null || true

  # Start iscsid for storage
  - systemctl enable iscsid
  - systemctl start iscsid

%{ if tailscale_auth_key != "" }
  # Install Tailscale
  - curl -fsSL https://tailscale.com/install.sh | sh
  - tailscale up --auth-key="${tailscale_auth_key}" --hostname="${hostname}" --accept-routes
%{ endif }

  # Run cluster setup
  - /usr/local/bin/metal-foundry-setup

final_message: |
  Metal Foundry cloud-init complete. Elapsed time: $UPTIME seconds.

  Check setup status:
    cat /var/log/metal-foundry-status

  View setup logs:
    sudo tail -f /var/log/metal-foundry-setup.log

  If setup failed, run manually:
    sudo /usr/local/bin/metal-foundry-setup
