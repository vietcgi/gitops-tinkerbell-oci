# Validation Pipeline
#
# Runs on all PRs to validate Kubernetes manifests and other configs.
#

name: Validate

on:
  pull_request:
    branches:
      - main

jobs:
  kubernetes:
    name: Kubernetes Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubeconform
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate Kubernetes manifests
        run: |
          find kubernetes -name '*.yaml' -type f | xargs kubeconform -strict -ignore-missing-schemas -summary

  tinkerbell:
    name: Tinkerbell Configs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          python3 -c "
          import yaml
          import sys
          import os

          errors = []
          for root, dirs, files in os.walk('tinkerbell'):
              for file in files:
                  if file.endswith('.yaml') or file.endswith('.yml'):
                      path = os.path.join(root, file)
                      try:
                          with open(path) as f:
                              list(yaml.safe_load_all(f))
                      except yaml.YAMLError as e:
                          errors.append(f'{path}: {e}')

          if errors:
              for e in errors:
                  print(f'ERROR: {e}')
              sys.exit(1)
          print('All Tinkerbell configs are valid YAML')
          "

  shellcheck:
    name: Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning

  markdown:
    name: Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lint Markdown
        uses: DavidAnson/markdownlint-cli2-action@v14
        with:
          globs: '**/*.md'
