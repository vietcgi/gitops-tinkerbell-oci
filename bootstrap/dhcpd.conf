#
# /etc/dhcp/dhcpd.conf
# PXE → iPXE → HTTP chainloading for Tinkerbell provisioning
#

default-lease-time 600;
max-lease-time 7200;
authoritative;
log-facility local7;

# -----------------------------
# 1. iPXE custom DHCP options
# -----------------------------
option space ipxe;
option ipxe-encap-opts code 175 = encapsulate ipxe;
option ipxe.user-class code 77 = string;
option arch code 93 = unsigned integer 16; # UEFI architecture indicator (RFC4578)

# -----------------------------
# 2. Subnet definition
# -----------------------------
subnet 108.181.38.64 netmask 255.255.255.224 {

    # DHCP range
    range 108.181.38.86 108.181.38.94;

    # Standard network options
    option routers 108.181.38.65;
    option subnet-mask 255.255.255.224;
    option domain-name-servers 8.8.8.8;

    # Boot server (TFTP + iPXE HTTP host)
    next-server 108.181.38.67;

    # -----------------------------
    # 3. Static reservations
    # -----------------------------

    host colo-server-01 {
        hardware ethernet 00:0c:29:73:03:4b;
        fixed-address 108.181.38.85;
    }

    # Dell R610 with Broadcom bnx2 NICs
    host anvil {
        hardware ethernet 00:21:9b:a1:dc:c0;
        fixed-address 108.181.38.87;
    }

    # -----------------------------
    # 4. PXE → iPXE chainloading
    # -----------------------------
    # Logic:
    #   - If client is already iPXE → send HTTP script
    #   - If UEFI → load ipxe.efi
    #   - If BIOS with Broadcom bnx2 → load undionly-embedded.kpxe (has static IP fallback)
    #   - Other BIOS → load undionly-embedded.kpxe
    # -----------------------------

    # STEP 2: Client is already running iPXE (sets user-class)
    # All machines go to Tinkerbell - the workflow determines what gets installed
    if exists user-class and option user-class = "iPXE" {
        option ipxe.user-class "iPXE";
        next-server 108.181.38.67;
        filename "http://108.181.38.67:8080/handoff.ipxe";
    }
    # STEP 1: Raw firmware PXE (BIOS/UEFI)
    else {
        # UEFI x86_64 → use ipxe.efi
        if option arch = 00:07 or option arch = 00:09 {
            filename "ipxe.efi";
        }
        # Dell R610 with Broadcom bnx2 (MAC prefix 00:21:9b)
        # Uses embedded script with static IP fallback due to buggy UNDI driver
        else if substring(hardware, 1, 3) = 00:21:9b {
            filename "undionly-embedded.kpxe";
        }
        # Other Legacy BIOS
        else {
            filename "undionly-embedded.kpxe";
        }
    }
}
