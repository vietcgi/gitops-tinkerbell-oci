---
# Ubuntu 24.04 LTS (Noble Numbat) Installation Template
# Uses nsenter to refresh partition table after image2disk (fixes mount failures)
apiVersion: tinkerbell.org/v1alpha1
kind: Template
metadata:
  name: ubuntu-2404
  namespace: tink-system
spec:
  data: |
    version: "0.1"
    name: ubuntu-2404
    global_timeout: 1800
    tasks:
      - name: os-installation
        worker: "{{.device_1}}"
        volumes:
          - /dev:/dev
          - /dev/console:/dev/console
          - /lib/firmware:/lib/firmware:ro
        actions:
          - name: stream-ubuntu-image
            image: quay.io/tinkerbell/actions/image2disk:latest
            timeout: 300
            environment:
              DEST_DISK: /dev/sda
              IMG_URL: https://hookos.qualityspace.com/noble.raw.gz
              COMPRESSED: "true"
          # CRITICAL: Refresh partition table using nsenter to run in host mount namespace
          # This fixes the issue where image2disk's BLKRRPART call fails silently
          # Using justincormack/nsenter1 - a minimal image designed specifically for this purpose
          # Note: partprobe may fail if partitions are in use, so we use || true
          - name: partition-refresh
            image: justincormack/nsenter1
            timeout: 60
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "partprobe /dev/sda || true; sleep 2; ls -la /dev/sda*"]
          # Clear cloud-init state so it runs fresh on first boot with new instance-id/hostname
          # Idempotent: unmounts first if already mounted, handles missing dirs gracefully
          - name: reset-cloud-init-state
            image: justincormack/nsenter1
            timeout: 120
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "umount /mnt 2>/dev/null || true; mount /dev/sda1 /mnt && rm -rf /mnt/var/lib/cloud/instances/* /mnt/var/lib/cloud/instance /mnt/var/lib/cloud/data/* 2>/dev/null; rm -f /mnt/etc/machine-id; echo 'uninitialized' > /mnt/etc/machine-id; umount /mnt"]
          - name: write-netplan
            image: quay.io/tinkerbell/actions/writefile:latest
            timeout: 90
            environment:
              DEST_DISK: /dev/sda1
              FS_TYPE: ext4
              DEST_PATH: /etc/netplan/50-cloud-init.yaml
              CONTENTS: |
                network:
                  version: 2
                  ethernets:
                    ens160:
                      dhcp4: false
                      dhcp6: false
                      addresses:
                        - 108.181.38.85/27
                      routes:
                        - to: 0.0.0.0/0
                          via: 108.181.38.65
                      nameservers:
                        addresses:
                          - 8.8.8.8
                          - 8.8.4.4
              UID: "0"
              GID: "0"
              MODE: "0644"
              DIRMODE: "0755"
          - name: write-cloud-init-meta
            image: quay.io/tinkerbell/actions/writefile:latest
            timeout: 90
            environment:
              DEST_DISK: /dev/sda1
              FS_TYPE: ext4
              DEST_PATH: /var/lib/cloud/seed/nocloud/meta-data
              CONTENTS: |
                instance-id: {{.device_1}}
                local-hostname: {{.hostname}}
              UID: "0"
              GID: "0"
              MODE: "0644"
              DIRMODE: "0755"
          - name: write-cloud-init-user
            image: quay.io/tinkerbell/actions/writefile:latest
            timeout: 90
            environment:
              DEST_DISK: /dev/sda1
              FS_TYPE: ext4
              DEST_PATH: /var/lib/cloud/seed/nocloud/user-data
              CONTENTS: |
                #cloud-config
                hostname: {{.hostname}}
                manage_etc_hosts: true
                users:
                  - name: ubuntu
                    sudo: ALL=(ALL) NOPASSWD:ALL
                    shell: /bin/bash
                    lock_passwd: false
                    ssh_authorized_keys:
                      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5/lrhHAQdTRfppzfA7Emn/hcSHobEpl6LzNFsxD9Pi0+sRT8K2shdwZ02vk+eZT3chi6Pwf5Cb82/NS7yLlq4eUxG/IKp1HxVKTdTQgA3E0HF/mmwveCnuR55iUvNNliRyWbBnY/uw5yfhVrDIyAwP+rE16M/ROlorbskJ4R6fFMr4M4o2PjAFL2KH+1lnMrtbNoovqg7/xLBhiDGhs6sNHl4E34PHICkH7Xqkh+7TCDbpjDGxMuNL5RG1zMG1fLFfJX0QIQanN2jHJU2NEMBVWB+BxNYWKWACHQevubER8KdxksBj3Newi65zx2enDoKNE6kpzi2lqPdDpUXwwVf kevin
                      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIND/fC/qBE102c4RLsxdto+62Zaq4KdlqSQwpuWR9wcC ubuntu@metal-foundry-control
                chpasswd:
                  list: |
                    root:$6$6cUHnjJ1JvrwzVVL$9qXzyIVh1CgCIaLkSyadZ2gJeiofWZ0rAVUoPWQQPMMFW31Y2dmXToe3jzG3wZPnXh3gvv3EGZGxXh/mcvS.S1
                    ubuntu:$6$6cUHnjJ1JvrwzVVL$9qXzyIVh1CgCIaLkSyadZ2gJeiofWZ0rAVUoPWQQPMMFW31Y2dmXToe3jzG3wZPnXh3gvv3EGZGxXh/mcvS.S1
                  expire: false
                ssh_pwauth: true
                package_update: true
                package_upgrade: true
                packages:
                  - qemu-guest-agent
                  - curl
                  - vim
                runcmd:
                  - systemctl enable qemu-guest-agent
                  - systemctl start qemu-guest-agent
                  # Tinkerbell provisioning marker - proves this is a fresh install
                  - echo "tinkerbell_provisioned=$(date +%s)" > /var/lib/tinkerbell-provisioned
              UID: "0"
              GID: "0"
              MODE: "0644"
              DIRMODE: "0755"
          # Install GRUB bootloader for UEFI using nsenter (mount EFI partition first)
          # Ubuntu cloud images use sda15 for EFI System Partition
          # --removable installs to /EFI/BOOT/BOOTX64.EFI (UEFI fallback path)
          # IMPORTANT: Must create /boot/efi directory - Ubuntu cloud images have empty /boot
          # Idempotent: cleans up any existing mounts before starting
          - name: install-grub-uefi
            image: justincormack/nsenter1
            timeout: 180
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "umount /mnt/sys /mnt/proc /mnt/dev /mnt/boot/efi /mnt 2>/dev/null || true; mount /dev/sda1 /mnt && mkdir -p /mnt/boot/efi && mount /dev/sda15 /mnt/boot/efi && mount --bind /dev /mnt/dev && mount --bind /proc /mnt/proc && mount --bind /sys /mnt/sys && chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot/efi --removable && chroot /mnt update-grub; umount /mnt/sys /mnt/proc /mnt/dev /mnt/boot/efi /mnt 2>/dev/null || true"]
          # Reboot using nsenter (host namespace) - actually reboots the machine
          # This action won't complete because reboot terminates HookOS, but workflow already SUCCESS
          - name: reboot-into-os
            image: justincormack/nsenter1
            timeout: 30
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "sync && reboot -f"]
---
# Ubuntu 24.04 LTS Installation Template for anvil (Dell R610)
# Uses nsenter to refresh partition table after image2disk (fixes mount failures)
apiVersion: tinkerbell.org/v1alpha1
kind: Template
metadata:
  name: anvil-ubuntu-2404
  namespace: tink-system
spec:
  data: |
    version: "0.1"
    name: anvil-ubuntu-2404
    global_timeout: 1800
    tasks:
      - name: os-installation
        worker: "{{.device_1}}"
        volumes:
          - /dev:/dev
          - /dev/console:/dev/console
          - /lib/firmware:/lib/firmware:ro
        actions:
          - name: stream-ubuntu-image
            image: quay.io/tinkerbell/actions/image2disk:latest
            timeout: 600
            environment:
              DEST_DISK: /dev/sda
              # Custom Ubuntu image with bnx2 firmware pre-installed
              IMG_URL: http://108.181.38.67:8081/noble-bnx2.raw.gz
              COMPRESSED: "true"
          # CRITICAL: Refresh partition table using nsenter to run in host mount namespace
          # Note: partprobe may fail if partitions are in use, so we use || true
          - name: partition-refresh
            image: justincormack/nsenter1
            timeout: 60
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "partprobe /dev/sda || true; sleep 2; ls -la /dev/sda*"]
          # Clear cloud-init state so it runs fresh on first boot with new instance-id/hostname
          # Idempotent: unmounts first if already mounted, handles missing dirs gracefully
          - name: reset-cloud-init-state
            image: justincormack/nsenter1
            timeout: 120
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "umount /mnt 2>/dev/null || true; mount /dev/sda1 /mnt && rm -rf /mnt/var/lib/cloud/instances/* /mnt/var/lib/cloud/instance /mnt/var/lib/cloud/data/* 2>/dev/null; rm -f /mnt/etc/machine-id; echo 'uninitialized' > /mnt/etc/machine-id; umount /mnt"]
          - name: write-netplan
            image: quay.io/tinkerbell/actions/writefile:latest
            timeout: 90
            environment:
              DEST_DISK: /dev/sda1
              FS_TYPE: ext4
              DEST_PATH: /etc/netplan/50-cloud-init.yaml
              CONTENTS: |
                network:
                  version: 2
                  ethernets:
                    eno1:
                      dhcp4: false
                      dhcp6: false
                      addresses:
                        - 108.181.38.87/27
                      routes:
                        - to: 0.0.0.0/0
                          via: 108.181.38.65
                      nameservers:
                        addresses:
                          - 8.8.8.8
                          - 8.8.4.4
              UID: "0"
              GID: "0"
              MODE: "0644"
              DIRMODE: "0755"
          - name: write-cloud-init-meta
            image: quay.io/tinkerbell/actions/writefile:latest
            timeout: 90
            environment:
              DEST_DISK: /dev/sda1
              FS_TYPE: ext4
              DEST_PATH: /var/lib/cloud/seed/nocloud/meta-data
              CONTENTS: |
                instance-id: {{.device_1}}
                local-hostname: {{.hostname}}
              UID: "0"
              GID: "0"
              MODE: "0644"
              DIRMODE: "0755"
          - name: write-cloud-init-user
            image: quay.io/tinkerbell/actions/writefile:latest
            timeout: 90
            environment:
              DEST_DISK: /dev/sda1
              FS_TYPE: ext4
              DEST_PATH: /var/lib/cloud/seed/nocloud/user-data
              CONTENTS: |
                #cloud-config
                hostname: {{.hostname}}
                manage_etc_hosts: true
                users:
                  - name: ubuntu
                    sudo: ALL=(ALL) NOPASSWD:ALL
                    shell: /bin/bash
                    lock_passwd: false
                    ssh_authorized_keys:
                      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5/lrhHAQdTRfppzfA7Emn/hcSHobEpl6LzNFsxD9Pi0+sRT8K2shdwZ02vk+eZT3chi6Pwf5Cb82/NS7yLlq4eUxG/IKp1HxVKTdTQgA3E0HF/mmwveCnuR55iUvNNliRyWbBnY/uw5yfhVrDIyAwP+rE16M/ROlorbskJ4R6fFMr4M4o2PjAFL2KH+1lnMrtbNoovqg7/xLBhiDGhs6sNHl4E34PHICkH7Xqkh+7TCDbpjDGxMuNL5RG1zMG1fLFfJX0QIQanN2jHJU2NEMBVWB+BxNYWKWACHQevubER8KdxksBj3Newi65zx2enDoKNE6kpzi2lqPdDpUXwwVf kevin
                      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIND/fC/qBE102c4RLsxdto+62Zaq4KdlqSQwpuWR9wcC ubuntu@metal-foundry-control
                chpasswd:
                  list: |
                    root:$6$6cUHnjJ1JvrwzVVL$9qXzyIVh1CgCIaLkSyadZ2gJeiofWZ0rAVUoPWQQPMMFW31Y2dmXToe3jzG3wZPnXh3gvv3EGZGxXh/mcvS.S1
                    ubuntu:$6$6cUHnjJ1JvrwzVVL$9qXzyIVh1CgCIaLkSyadZ2gJeiofWZ0rAVUoPWQQPMMFW31Y2dmXToe3jzG3wZPnXh3gvv3EGZGxXh/mcvS.S1
                  expire: false
                ssh_pwauth: true
                package_update: true
                package_upgrade: true
                packages:
                  - qemu-guest-agent
                  - curl
                  - vim
                runcmd:
                  - systemctl enable qemu-guest-agent
                  - systemctl start qemu-guest-agent
                  # Tinkerbell provisioning marker - proves this is a fresh install
                  - echo "tinkerbell_provisioned=$(date +%s)" > /var/lib/tinkerbell-provisioned
              UID: "0"
              GID: "0"
              MODE: "0644"
              DIRMODE: "0755"
          # Install Broadcom bnx2 firmware for Dell R610 NICs
          # Copy firmware from HookOS (which has it) and regenerate initramfs
          # This avoids network dependency during provisioning
          # Ubuntu cloud images have kernel on sda16 (boot partition), must mount to /boot
          # Idempotent: cleans up mounts before starting, handles missing firmware gracefully
          - name: install-bnx2-firmware
            image: justincormack/nsenter1
            timeout: 180
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "umount /mnt/sys /mnt/proc /mnt/dev /mnt/boot /mnt 2>/dev/null || true; mount /dev/sda1 /mnt && mount /dev/sda16 /mnt/boot && mkdir -p /mnt/lib/firmware/bnx2 && cp -v /lib/firmware/bnx2/* /mnt/lib/firmware/bnx2/ 2>/dev/null || echo 'No bnx2 firmware in HookOS'; mount --bind /dev /mnt/dev && mount --bind /proc /mnt/proc && mount --bind /sys /mnt/sys && chroot /mnt update-initramfs -u -k all; echo 'Firmware files:'; ls -la /mnt/lib/firmware/bnx2/ 2>/dev/null || true; umount /mnt/sys /mnt/proc /mnt/dev /mnt/boot /mnt 2>/dev/null || true"]
          # Install GRUB bootloader for BIOS/MBR using nsenter
          # Must bind mount /dev, /proc, /sys for grub-install to detect disk properly
          # Ubuntu cloud images have kernel on sda16 (boot partition), must mount to /boot
          # Idempotent: cleans up mounts before starting
          - name: install-grub
            image: justincormack/nsenter1
            timeout: 180
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "umount /mnt/sys /mnt/proc /mnt/dev /mnt/boot /mnt 2>/dev/null || true; mount /dev/sda1 /mnt && mount /dev/sda16 /mnt/boot && mount --bind /dev /mnt/dev && mount --bind /proc /mnt/proc && mount --bind /sys /mnt/sys && chroot /mnt grub-install /dev/sda && chroot /mnt update-grub; umount /mnt/sys /mnt/proc /mnt/dev /mnt/boot /mnt 2>/dev/null || true"]
          # Reboot using nsenter (host namespace) - actually reboots the machine
          # This action won't complete because reboot terminates HookOS, but workflow already SUCCESS
          - name: reboot-into-os
            image: justincormack/nsenter1
            timeout: 30
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "sync && reboot -f"]
---
# Harvester HCI v1.6.1 Installation Template
# Downloads Harvester kernel/initrd and kexec's into the installer
# Harvester's installer handles disk partitioning and installation
apiVersion: tinkerbell.org/v1alpha1
kind: Template
metadata:
  name: harvester
  namespace: tink-system
spec:
  data: |
    version: "0.1"
    name: harvester
    global_timeout: 1800
    tasks:
      - name: harvester-installation
        worker: "{{.device_1}}"
        volumes:
          - /dev:/dev
          - /dev/console:/dev/console
          - /lib/firmware:/lib/firmware:ro
        actions:
          # Install kexec-tools using Alpine apk (HookOS is Alpine-based)
          # Must use full path /sbin/apk since nsenter may not have /sbin in PATH
          - name: install-kexec-tools
            image: justincormack/nsenter1
            timeout: 120
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "/sbin/apk add --no-cache kexec-tools && /usr/sbin/kexec --version"]
          # Download Harvester kernel and initrd (custom initrd with bnx2 firmware for Dell R610)
          - name: download-harvester-files
            image: justincormack/nsenter1
            timeout: 600
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "mkdir -p /tmp/harvester && cd /tmp/harvester && wget -q http://108.181.38.67:8081/harvester/harvester-v1.6.1-vmlinuz-amd64 -O vmlinuz && wget -q http://108.181.38.67:8081/harvester/harvester-v1.6.1-initrd-bnx2-amd64 -O initrd && echo 'Downloaded:' && ls -la /tmp/harvester/"]
          # Kexec into Harvester installer
          # The kernel cmdline tells Harvester where to get rootfs and config
          # Using static IP because DHCP times out before dracut can fetch rootfs
          # Format: ip=<client-ip>::<gateway>:<netmask>:<hostname>:<device>:none
          # Using eth0 (traditional naming) - more reliable for Dell R610 Broadcom NICs
          - name: kexec-harvester
            image: justincormack/nsenter1
            timeout: 60
            pid: host
            command: ["/usr/bin/nsenter", "-t", "1", "-m", "-u", "-i", "-n", "--", "/bin/sh", "-c", "kexec -l /tmp/harvester/vmlinuz --initrd=/tmp/harvester/initrd --command-line='ip=108.181.38.87::108.181.38.65:255.255.255.224:anvil:eth0:none net.ifnames=0 biosdevname=0 pci=nomsi rd.cos.disable rd.noverifyssl console=tty1 root=live:http://108.181.38.67:8081/harvester/harvester-v1.6.1-rootfs-bnx2-amd64.squashfs harvester.install.automatic=true harvester.install.config_url=http://108.181.38.67:8081/harvester/config-create.yaml harvester.install.skipchecks=true' && kexec -e"]
---
# Talos Linux v1.11.5 Installation Template for Dell R610 (anvil)
# Uses iPXE boot (no HookOS/kexec) - Tinkerbell controls when to boot Talos
# Talos handles disk partitioning, installation, and cluster bootstrap
apiVersion: tinkerbell.org/v1alpha1
kind: Template
metadata:
  name: talos
  namespace: tink-system
spec:
  # iPXE boot template - Tinkerbell serves this script instead of HookOS
  # When workflow is active, Smee returns this iPXE script to boot Talos directly
  ipxe: |
    #!ipxe
    echo Tinkerbell: Booting Talos Linux v1.11.5 for {{.device_1}}
    set base http://108.181.38.67:8081/talos
    kernel ${base}/vmlinuz-amd64 talos.platform=metal talos.config=${base}/controlplane.yaml net.ifnames=0 biosdevname=0 console=tty0 console=ttyS1,115200n8 init_on_alloc=1 slab_nomerge pti=on initrd=initramfs-amd64.xz
    initrd ${base}/initramfs-amd64.xz
    boot
