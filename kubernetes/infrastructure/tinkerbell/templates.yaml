---
# Ubuntu 24.04 LTS (Noble Numbat) Installation Template
# Uses Tinkerbell actions to stream OS image to disk
apiVersion: tinkerbell.org/v1alpha1
kind: Template
metadata:
  name: ubuntu-2404
  namespace: tink-system
spec:
  data: |
    version: "0.1"
    name: ubuntu-2404
    global_timeout: 1800
    tasks:
      - name: os-installation
        worker: "{{.device_1}}"
        volumes:
          - /dev:/dev
          - /dev/console:/dev/console
          - /lib/firmware:/lib/firmware:ro
        actions:
          - name: stream-ubuntu-image
            image: quay.io/tinkerbell/actions/image2disk:latest
            timeout: 300
            environment:
              DEST_DISK: /dev/sda
              # Pre-converted raw.gz hosted locally for fast provisioning (~1-2 min vs 22 min)
              IMG_URL: https://hookos.qualityspace.com/noble.raw.gz
              COMPRESSED: true
          - name: write-netplan
            image: quay.io/tinkerbell/actions/writefile:latest
            timeout: 90
            environment:
              DEST_DISK: /dev/sda2
              FS_TYPE: ext4
              DEST_PATH: /etc/netplan/50-cloud-init.yaml
              CONTENTS: |
                network:
                  version: 2
                  ethernets:
                    ens160:
                      dhcp4: false
                      dhcp6: false
                      addresses:
                        - 108.181.38.85/27
                      routes:
                        - to: 0.0.0.0/0
                          via: 108.181.38.65
                      nameservers:
                        addresses:
                          - 8.8.8.8
                          - 8.8.4.4
              UID: "0"
              GID: "0"
              MODE: "0644"
          - name: write-cloud-init-meta
            image: quay.io/tinkerbell/actions/writefile:latest
            timeout: 90
            environment:
              DEST_DISK: /dev/sda2
              FS_TYPE: ext4
              DEST_PATH: /var/lib/cloud/seed/nocloud/meta-data
              CONTENTS: |
                instance-id: {{.device_1}}
                local-hostname: {{.hostname}}
              UID: "0"
              GID: "0"
              MODE: "0644"
              DIRMODE: "0755"
          - name: write-cloud-init-user
            image: quay.io/tinkerbell/actions/writefile:latest
            timeout: 90
            environment:
              DEST_DISK: /dev/sda2
              FS_TYPE: ext4
              DEST_PATH: /var/lib/cloud/seed/nocloud/user-data
              CONTENTS: |
                #cloud-config
                hostname: {{.hostname}}
                manage_etc_hosts: true
                users:
                  - name: ubuntu
                    sudo: ALL=(ALL) NOPASSWD:ALL
                    shell: /bin/bash
                    lock_passwd: false
                    ssh_authorized_keys:
                      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5/lrhHAQdTRfppzfA7Emn/hcSHobEpl6LzNFsxD9Pi0+sRT8K2shdwZ02vk+eZT3chi6Pwf5Cb82/NS7yLlq4eUxG/IKp1HxVKTdTQgA3E0HF/mmwveCnuR55iUvNNliRyWbBnY/uw5yfhVrDIyAwP+rE16M/ROlorbskJ4R6fFMr4M4o2PjAFL2KH+1lnMrtbNoovqg7/xLBhiDGhs6sNHl4E34PHICkH7Xqkh+7TCDbpjDGxMuNL5RG1zMG1fLFfJX0QIQanN2jHJU2NEMBVWB+BxNYWKWACHQevubER8KdxksBj3Newi65zx2enDoKNE6kpzi2lqPdDpUXwwVf kevin
                chpasswd:
                  list: |
                    root:$6$6cUHnjJ1JvrwzVVL$9qXzyIVh1CgCIaLkSyadZ2gJeiofWZ0rAVUoPWQQPMMFW31Y2dmXToe3jzG3wZPnXh3gvv3EGZGxXh/mcvS.S1
                    ubuntu:$6$6cUHnjJ1JvrwzVVL$9qXzyIVh1CgCIaLkSyadZ2gJeiofWZ0rAVUoPWQQPMMFW31Y2dmXToe3jzG3wZPnXh3gvv3EGZGxXh/mcvS.S1
                  expire: false
                ssh_pwauth: true
                package_update: true
                package_upgrade: true
                packages:
                  - qemu-guest-agent
                  - curl
                  - vim
                runcmd:
                  - systemctl enable qemu-guest-agent
                  - systemctl start qemu-guest-agent
              UID: "0"
              GID: "0"
              MODE: "0644"
              DIRMODE: "0755"
          - name: reboot
            image: quay.io/tinkerbell/actions/kexec:latest
            timeout: 90
            pid: host
            environment:
              BLOCK_DEVICE: /dev/sda2
              FS_TYPE: ext4
