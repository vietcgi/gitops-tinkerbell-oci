---
# Tinkerbell Namespace
# Using tink-system as per Tinkerbell convention
apiVersion: v1
kind: Namespace
metadata:
  name: tink-system
  labels:
    app.kubernetes.io/name: tinkerbell
---
# Tinkerbell Helm Release (unified chart)
#
# Architecture: iPXE chainloading over HTTPS
# - Control plane on OCI cloud
# - Bare metal at home lab / colo sites
# - Local DHCP points to https://tinkerbell.qualityspace.com/auto.ipxe
# - Rufio controls BMC (iDRAC/IPMI) via network
#
# Components enabled:
# - Smee: iPXE server (DHCP disabled - sites have their own)
# - Tink Server & Controller: Workflow engine
# - Rufio: BMC controller for iDRAC/Supermicro IPMI
# - Tootles: Artifact server for HookOS
#
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tinkerbell
  namespace: tink-system
spec:
  interval: 1h
  chart:
    spec:
      chart: tinkerbell
      version: "v0.21.1-f2610bdd"
      sourceRef:
        kind: HelmRepository
        name: tinkerbell
        namespace: flux-system
  values:
    # Public address for HookOS to connect back to Tinkerbell
    # Must be reachable from bare metal servers during provisioning
    # Using domain name since gRPC is exposed via Gateway API on port 80
    publicIP: "tinkerbell.qualityspace.com"

    # Trusted proxies (Cilium pod CIDR)
    trustedProxies:
      - "10.42.0.0/16"

    # HookOS artifacts URL - served via Gateway API with HTTPS
    # Uses hookos.qualityspace.com (DNS-only in Cloudflare, not proxied)
    artifactsFileServer: "https://hookos.qualityspace.com"

    # Deployment configuration
    deployment:
      replicas: 1
      # Don't use hostNetwork - we're behind Gateway API
      hostNetwork: false

      # Feature flags
      envs:
        globals:
          # Enable all required components
          enableSmee: true
          enableTinkServer: true
          enableTinkController: true
          enableRufioController: true
          enableTootles: true
          # Disable SSH bastion (secondstar)
          enableSecondstar: false

        smee:
          # Disable DHCP - each site has its own DHCP server
          # Local DHCP configured to chainload iPXE from this URL
          dhcpEnabled: false
          # Enable HTTP iPXE script serving at /auto.ipxe
          httpIpxeScriptEnabled: true
          httpIpxeScriptUrl: "https://tinkerbell.qualityspace.com"
          # gRPC endpoint for HookOS tink-worker to connect to
          # Using HTTP:80 due to Cilium ALPN bug (https://github.com/cilium/cilium/issues/30794)
          # GRPCRoute only works on HTTP listener, not HTTPS
          ipxeScriptTinkServerAddrPort: "tinkerbell.qualityspace.com:80"
          ipxeScriptTinkServerUseTLS: false

      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 512Mi

    # Service configuration - use ClusterIP since we're behind Gateway API
    service:
      type: ClusterIP

    # Optional components
    optional:
      # HookOS - in-memory provisioning OS
      hookos:
        enabled: true
        downloadURL: "https://github.com/tinkerbell/hook/releases/download/v0.11.1"
        # Use ClusterIP - served via Gateway API at hookos.qualityspace.com
        service:
          type: ClusterIP
      # Disable kubevip - using Cilium L2 announcements
      kubevip:
        enabled: false

  # Post-render patches for service appProtocol
  postRenderers:
    - kustomize:
        patches:
          # hookos: HTTP/1.1 (nginx doesn't support HTTP/2)
          - target:
              kind: Service
              name: hookos
            patch: |
              - op: add
                path: /spec/ports/0/appProtocol
                value: http
          # tinkerbell: gRPC uses HTTP/2 plaintext (h2c)
          - target:
              kind: Service
              name: tinkerbell
            patch: |
              - op: add
                path: /spec/ports/5/appProtocol
                value: kubernetes.io/h2c
---
# HTTPRoute for HookOS artifacts (kernel, initramfs) - HTTPS
# Served at hookos.qualityspace.com (DNS-only in Cloudflare)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: hookos-route
  namespace: tink-system
spec:
  parentRefs:
    - name: main-gateway
      namespace: ingress
      sectionName: https
  hostnames:
    - hookos.qualityspace.com
  rules:
    - backendRefs:
        - name: hookos
          port: 7173
---
# HTTPRoute for HookOS artifacts - HTTP (for iPXE which doesn't support TLS 1.3)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: hookos-http
  namespace: tink-system
spec:
  parentRefs:
    - name: main-gateway
      namespace: ingress
      sectionName: http
  hostnames:
    - hookos.qualityspace.com
  rules:
    - backendRefs:
        - name: hookos
          port: 7173
---
# HTTPRoute for Tinkerbell services
# TLS handled by wildcard cert in ingress namespace
# Routes traffic from main-gateway to Tinkerbell
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: tinkerbell-route
  namespace: tink-system
spec:
  parentRefs:
    - name: main-gateway
      namespace: ingress
      sectionName: https
  hostnames:
    - tinkerbell.qualityspace.com
  rules:
    # iPXE auto script - this is what DHCP points to
    # Rewrite /auto.ipxe to /ipxe/script/auto.ipxe for Smee
    - matches:
        - path:
            type: Exact
            value: /auto.ipxe
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplaceFullPath
              replaceFullPath: /ipxe/script/auto.ipxe
      backendRefs:
        - name: tinkerbell
          port: 7171
    # Smee HTTP endpoints
    - matches:
        - path:
            type: PathPrefix
            value: /ipxe
      backendRefs:
        - name: tinkerbell
          port: 7171
---
# GRPCRoute for Tink Server gRPC API
# tink-agent in HookOS connects here to get workflows
# NOTE: Using HTTP listener due to Cilium ALPN bug (https://github.com/cilium/cilium/issues/30794)
# HTTPS listener doesn't negotiate ALPN, breaking gRPC clients
apiVersion: gateway.networking.k8s.io/v1
kind: GRPCRoute
metadata:
  name: tinkerbell-grpc
  namespace: tink-system
spec:
  parentRefs:
    - name: main-gateway
      namespace: ingress
      sectionName: http
  hostnames:
    - tinkerbell.qualityspace.com
  rules:
    - backendRefs:
        - name: tinkerbell
          port: 42113
---
# HTTP Route for Tinkerbell iPXE endpoints (no redirect for iPXE)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: tinkerbell-http
  namespace: tink-system
spec:
  parentRefs:
    - name: main-gateway
      namespace: ingress
      sectionName: http
  hostnames:
    - tinkerbell.qualityspace.com
  rules:
    # iPXE auto script - serve directly over HTTP (iPXE TLS issues)
    - matches:
        - path:
            type: Exact
            value: /auto.ipxe
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplaceFullPath
              replaceFullPath: /ipxe/script/auto.ipxe
      backendRefs:
        - name: tinkerbell
          port: 7171
    # iPXE endpoints - serve directly over HTTP
    - matches:
        - path:
            type: PathPrefix
            value: /ipxe
      backendRefs:
        - name: tinkerbell
          port: 7171
    # Everything else redirects to HTTPS
    - matches:
        - path:
            type: PathPrefix
            value: /
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
---
# PodDisruptionBudget for availability
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: tinkerbell-pdb
  namespace: tink-system
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: tinkerbell
