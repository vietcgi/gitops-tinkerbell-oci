---
# Tinkerbell Namespace
# Using tink-system as per Tinkerbell convention
apiVersion: v1
kind: Namespace
metadata:
  name: tink-system
  labels:
    app.kubernetes.io/name: tinkerbell
---
# Tinkerbell Helm Release (unified chart)
#
# Architecture: iPXE chainloading over HTTPS
# - Control plane on OCI cloud
# - Bare metal at home lab / colo sites
# - Local DHCP points to https://tinkerbell.qualityspace.com/auto.ipxe
# - Rufio controls BMC (iDRAC/IPMI) via network
#
# Components enabled:
# - Smee: iPXE server (DHCP disabled - sites have their own)
# - Tink Server & Controller: Workflow engine
# - Rufio: BMC controller for iDRAC/Supermicro IPMI
# - Tootles: Artifact server for HookOS
#
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: tinkerbell
  namespace: tink-system
spec:
  interval: 1h
  chart:
    spec:
      chart: tinkerbell
      version: "v0.21.1-f2610bdd"
      sourceRef:
        kind: HelmRepository
        name: tinkerbell
        namespace: flux-system
  values:
    # Public IP for internal service discovery
    # External access is via Gateway API at tinkerbell.qualityspace.com
    publicIP: "170.9.8.103"

    # Trusted proxies (Cilium pod CIDR)
    trustedProxies:
      - "10.42.0.0/16"

    # HookOS artifacts URL - served via NodePort (Gateway has HTTP/2 issues with nginx)
    artifactsFileServer: "http://170.9.8.103:30080"

    # Deployment configuration
    deployment:
      replicas: 1
      # Don't use hostNetwork - we're behind Gateway API
      hostNetwork: false

      # Feature flags
      envs:
        globals:
          # Enable all required components
          enableSmee: true
          enableTinkServer: true
          enableTinkController: true
          enableRufioController: true
          enableTootles: true
          # Disable SSH bastion (secondstar)
          enableSecondstar: false

        smee:
          # Disable DHCP - each site has its own DHCP server
          # Local DHCP configured to chainload iPXE from this URL
          dhcpEnabled: false

      resources:
        requests:
          cpu: 100m
          memory: 256Mi
        limits:
          cpu: 1000m
          memory: 512Mi

    # Service configuration - use ClusterIP since we're behind Gateway API
    service:
      type: ClusterIP

    # Optional components
    optional:
      # HookOS - in-memory provisioning OS
      hookos:
        enabled: true
        downloadURL: "https://github.com/tinkerbell/hook/releases/download/v0.11.1"
        # Use NodePort - Gateway API has HTTP/2 issues with nginx (HTTP/1.1 only)
        service:
          type: NodePort
          nodePort: 30080
      # Disable kubevip - using Cilium L2 announcements
      kubevip:
        enabled: false
---
# TLS Certificate for Tinkerbell
# Required for secure iPXE boot and API access
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: tinkerbell-tls
  namespace: tink-system
spec:
  secretName: tinkerbell-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - tinkerbell.qualityspace.com
---
# HTTPRoute for Tinkerbell services
# Routes traffic from main-gateway to Tinkerbell
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: tinkerbell-route
  namespace: tink-system
spec:
  parentRefs:
    - name: main-gateway
      namespace: ingress
      sectionName: https-tinkerbell
  hostnames:
    - tinkerbell.qualityspace.com
  rules:
    # iPXE auto script - this is what DHCP points to
    - matches:
        - path:
            type: Exact
            value: /auto.ipxe
      backendRefs:
        - name: tinkerbell
          port: 7171
    # Smee HTTP endpoints
    - matches:
        - path:
            type: PathPrefix
            value: /ipxe
      backendRefs:
        - name: tinkerbell
          port: 7171
    # Tink gRPC API (catch-all)
    # Note: HookOS files served via NodePort http://170.9.8.103:30080
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: tinkerbell
          port: 42113
---
# HTTP Route for Tinkerbell - redirects HTTP to HTTPS
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: tinkerbell-http
  namespace: tink-system
spec:
  parentRefs:
    - name: main-gateway
      namespace: ingress
      sectionName: http
  hostnames:
    - tinkerbell.qualityspace.com
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
---
# PodDisruptionBudget for availability
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: tinkerbell-pdb
  namespace: tink-system
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: tinkerbell
