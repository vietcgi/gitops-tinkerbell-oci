---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: cilium
  namespace: kube-system
spec:
  interval: 1h
  chart:
    spec:
      chart: cilium
      version: "1.18.4"  # Latest stable (Nov 2025)
      sourceRef:
        kind: HelmRepository
        name: cilium
        namespace: flux-system
  values:
    # Replace kube-proxy with Cilium
    kubeProxyReplacement: true

    # K3s API server
    k8sServiceHost: "localhost"
    k8sServicePort: 6443

    # Enable Cilium Ingress Controller
    ingressController:
      enabled: true
      loadbalancerMode: shared
      default: true

    # Enable L2 announcements for LoadBalancer services (bare metal)
    l2announcements:
      enabled: true

    # Enable external IPs
    externalIPs:
      enabled: true

    # Enable node port
    nodePort:
      enabled: true

    # Hubble observability
    hubble:
      enabled: true
      relay:
        enabled: true
      ui:
        enabled: true

    # Operator settings
    operator:
      replicas: 1
      resources:
        limits:
          cpu: 100m
          memory: 128Mi
        requests:
          cpu: 10m
          memory: 64Mi

    # Agent resources (optimized for free tier)
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 128Mi

    # IP address management
    ipam:
      mode: kubernetes

    # Enable bandwidth manager for better performance
    bandwidthManager:
      enabled: true

    # Enable BBR congestion control
    bpf:
      masquerade: true
---
# L2 Announcement Policy - respond to ARP for LoadBalancer IPs
# Used when bare metal workers join the cluster
apiVersion: cilium.io/v2alpha1
kind: CiliumL2AnnouncementPolicy
metadata:
  name: default-l2-policy
  namespace: kube-system
spec:
  interfaces:
    - ^eth[0-9]+
    - ^en[a-z0-9]+
    - ^ens[0-9]+
  externalIPs: true
  loadBalancerIPs: true
